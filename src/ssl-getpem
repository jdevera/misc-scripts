#!/usr/bin/env bash
# BRIEF: Get PEM certificate chain for an SSL connection
# DESC: Connects to the specified host and port, retrieves the SSL
# DESC: certificate chain, and outputs it in PEM format. Useful for
# DESC: inspecting certificates or adding them to trust stores.
# USAGE: ssl-getpem <host> [<port>] [<output-file>]
# USAGE:   host         - Hostname to connect to
# USAGE:   port         - Port number (default: 443)
# USAGE:   output-file  - Output file (default: stdout)
# DEPS: openssl

set -e

host="$1"
port="${2:-443}"
output="$3"

usage()
{
    echo "Usage: $(basename "$0") <host> [<port>] [<output-file>]">&2
    exit 1
}

[[ $# -lt 1 || $# -gt 3 ]] && usage

[[ -n $output || $output == '-' ]] && exec >"$output"

echo Q |
    openssl s_client -showcerts -connect "$host:$port" -prexit 2>/dev/null |
    sed -n -e '/BEGIN\ CERTIFICATE/,/END\ CERTIFICATE/ p'
